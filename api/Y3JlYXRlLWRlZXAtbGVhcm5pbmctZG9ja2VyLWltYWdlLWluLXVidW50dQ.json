{"title":"Ubuntu上从CUDA开始构建深度学习镜像","date":"2020-01-14T15:53:47.000Z","thumbnail":"create-deep-learning-docker-image-in-ubuntu/nvidia-docker-logo.png","link":"create-deep-learning-docker-image-in-ubuntu","comments":true,"tags":["docker","pytorch"],"categories":["linux"],"updated":"2022-01-04T08:35:48.567Z","content":"<p>本文介绍如何在ubuntu上从CUDA镜像开始构建深度学习镜像。</p>\n<a id=\"more\"></a>\n\n<h1 id=\"前置条件\">前置条件<a href=\"create-deep-learning-docker-image-in-ubuntu#前置条件\"></a></h1><ul>\n<li>已安装 docker 和 nvidia-docker</li>\n<li>安装好 nvidia driver （不要求安装 cuda 和 cudnn）</li>\n</ul>\n<h1 id=\"构建\">构建<a href=\"create-deep-learning-docker-image-in-ubuntu#构建\"></a></h1><h2 id=\"下载-cuda-镜像\">下载 cuda 镜像<a href=\"create-deep-learning-docker-image-in-ubuntu#下载-cuda-镜像\"></a></h2><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker pull nvidia/cuda:9.2-cudnn7-devel</span><br></pre></td></tr></table></div></figure>\n\n<p>更多cuda版本见<a href=\"https://hub.docker.com/r/nvidia/cuda/tags\" target=\"_blank\" rel=\"noopener\">此处</a>。</p>\n<p><strong>注意：</strong> </p>\n<ul>\n<li><p>下载cuda版本前请先确认宿主机的 nvidia driver 版本高于要安装的 cuda 版本要求，对应关系见<a href=\"https://github.com/NVIDIA/nvidia-docker/wiki/CUDA\" target=\"_blank\" rel=\"noopener\">此处</a>。</p>\n</li>\n<li><p>nvidia driver的版本可以通过 <code>nvidia-smi</code> 指令查看。</p>\n</li>\n</ul>\n<p>下载完成后使用以下命令验证是否安装成功：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nvidia-docker run --rm nvidia/cuda:9.2-cudnn7-devel nvidia-smi</span><br><span class=\"line\">sudo nvidia-docker run --rm nvidia/cuda:9.2-cudnn7-devel nvcc --version</span><br></pre></td></tr></table></div></figure>\n\n<p>若nvidia driver版本不满足要求，下载完成后运行会出现以下错误：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker: Error response from daemon: OCI runtime create failed: container_linux.go:345: starting container process caused &quot;process_linux.go:430: container init caused \\&quot;process_linux.go:413: running prestart hook 1 caused \\\\\\&quot;error running hook: exit status 1, stdout: , stderr: exec command: [/usr/bin/nvidia-container-cli --load-kmods configure --ldconfig=@/sbin/ldconfig.real --device=all --compute --utility --require=cuda&gt;=10.1 brand=tesla,driver&gt;=384,driver&lt;385 brand=tesla,driver&gt;=396,driver&lt;397 brand=tesla,driver&gt;=410,driver&lt;411 --pid=7808 /home/data/overlay2/5404e537b8e59d7717372339aa3c739b7dc498fe8dc00ca16b69149edab4a498/merged]\\\\\\\\nnvidia-container-cli: requirement error: unsatisfied condition: brand = tesla\\\\\\\\n\\\\\\&quot;\\&quot;&quot;: unknown.</span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"启动cuda容器\">启动cuda容器<a href=\"create-deep-learning-docker-image-in-ubuntu#启动cuda容器\"></a></h2><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nvidia-docker run --name container_name -it nvidia/cuda:9.2-cudnn7-devel /bin/bash</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>注：</strong> </p>\n<ul>\n<li><p><code>container_name</code> 可以自己改。</p>\n</li>\n<li><p>如果中途退出该容器了，可以通过以下指令进入：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nvidia-docker start container_name</span><br><span class=\"line\">sudo nvidia-docker attach container_name</span><br></pre></td></tr></table></div></figure>\n\n\n\n\n\n</li>\n</ul>\n<h2 id=\"apt-get-换源：\">apt-get 换源：<a href=\"create-deep-learning-docker-image-in-ubuntu#apt-get-换源：\"></a></h2><p>操作指南见<a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/\" target=\"_blank\" rel=\"noopener\">此处</a>。</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update        # 刷新原本的软件源</span><br><span class=\"line\">apt-get install vim   # 安装 vim</span><br><span class=\"line\"><span class=\"meta\">#</span> 按照操作指南更换 apt-get 软件源，可以使用 vi 命令编辑 /etc/apt/sources.list</span><br><span class=\"line\">apt-get update        # 更新为清华镜像源</span><br><span class=\"line\">apt-get install wget  # 安装 wget</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>注：</strong>必须先 <code>apt-get update</code> 否则软件源不会更新，会出现以下错误：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">E: Unable to locate package vim</span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"安装-anaconda3\">安装 anaconda3<a href=\"create-deep-learning-docker-image-in-ubuntu#安装-anaconda3\"></a></h2><p><strong>注：</strong>也可以选择更小的版本<a href=\"https://docs.conda.io/en/latest/miniconda.html\" target=\"_blank\" rel=\"noopener\">miniconda</a>。</p>\n<p>在<a href=\"https://www.anaconda.com/distribution/#linux\" target=\"_blank\" rel=\"noopener\">anaconda官网</a>复制安装脚本的链接地址，使用 <code>wget</code> 下载：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /home</span><br><span class=\"line\">wget https://repo.anaconda.com/archive/Anaconda3-2019.10-Linux-x86_64.sh</span><br></pre></td></tr></table></div></figure>\n\n<p>下载后运行脚本即可安装：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod +x Anaconda3-2019.10-Linux-x86_64.sh</span><br><span class=\"line\">./Anaconda3-2019.10-Linux-x86_64.sh</span><br></pre></td></tr></table></div></figure>\n\n<p>安装完成后退出，使安装生效：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exit</span><br></pre></td></tr></table></div></figure>\n\n<p>重新进入：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nvidia-docker start container_name</span><br><span class=\"line\">sudo nvidia-docker attach container_name</span><br></pre></td></tr></table></div></figure>\n\n<p>验证是否成功安装：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">conda --version</span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"pip-换源\">pip 换源<a href=\"create-deep-learning-docker-image-in-ubuntu#pip-换源\"></a></h2><p>操作指南见<a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/pypi/\" target=\"_blank\" rel=\"noopener\">此处</a>。</p>\n<h2 id=\"conda-换源\">conda 换源<a href=\"create-deep-learning-docker-image-in-ubuntu#conda-换源\"></a></h2><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi ~/.condarc   # 没有就新建</span><br></pre></td></tr></table></div></figure>\n\n<p>添加以下内容</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">channels:</span></span><br><span class=\"line\"><span class=\"attr\">  - https:</span><span class=\"string\">//mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main</span></span><br><span class=\"line\"><span class=\"attr\">  - https:</span><span class=\"string\">//mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free</span></span><br><span class=\"line\"><span class=\"attr\">  - https:</span><span class=\"string\">//mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">defaults</span></span><br><span class=\"line\"><span class=\"attr\">  - https:</span><span class=\"string\">//mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch</span></span><br><span class=\"line\"><span class=\"attr\">show_channel_urls:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"设置jupyter-notebook\">设置jupyter notebook<a href=\"create-deep-learning-docker-image-in-ubuntu#设置jupyter-notebook\"></a></h2><p><strong>注：</strong> 由于anaconda自带jupyter，此处略去jupyter的安装步骤。</p>\n<p>设置密码：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jupyter notebook --generate-config</span><br><span class=\"line\">jupyter notebook password</span><br></pre></td></tr></table></div></figure>\n\n<p>后台启动notebook：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jupyter notebook /base_dir --ip=0.0.0.0 --port=8888 --allow-root &amp;</span><br></pre></td></tr></table></div></figure>\n\n<p><strong>注：</strong> 使用 CTRL + P + Q 可以退出容器但不关闭容器，保持jupyter的运行</p>\n<h2 id=\"安装pytorch\">安装pytorch<a href=\"create-deep-learning-docker-image-in-ubuntu#安装pytorch\"></a></h2><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">conda install pytorch torchvision cudatoolkit=9.2  # 不需要加 -c pytorch</span><br></pre></td></tr></table></div></figure>\n\n<h2 id=\"打包成镜像\">打包成镜像<a href=\"create-deep-learning-docker-image-in-ubuntu#打包成镜像\"></a></h2><p>先退出容器，执行以下命令打包镜像</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker commit -m=\"comment\" -a=\"author_name\" container_id image_name:tag</span><br></pre></td></tr></table></div></figure>\n\n<h1 id=\"使用\">使用<a href=\"create-deep-learning-docker-image-in-ubuntu#使用\"></a></h1><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nvidia-docker run --shm-size 20G -p 9888:8888 -v /src_dir:/dst_dir --name container_name -it image_name:tag /bin/bash</span><br></pre></td></tr></table></div></figure>\n\n<ul>\n<li><code>--shm-size</code> 用于指定共享内存的大小，默认只有 64M。</li>\n</ul>\n<p>使用中可以用 CTRL + P + Q 退出容器但不关闭容器。</p>\n<p>使用以下命令可以在容器上另外开启一个终端，该终端中可以直接 <code>exit</code> 而不会影响容器运行:</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker exec -it container_name /bin/bash</span><br></pre></td></tr></table></div></figure>\n\n","prev":{"title":"frp内网穿透基本使用","link":"frp-basic"},"next":{"title":"python的奇妙技巧","link":"python-skill"},"plink":"https://yuxinzhao.net/create-deep-learning-docker-image-in-ubuntu/","toc":[{"title":"前置条件","id":"前置条件","index":"1"},{"title":"构建","id":"构建","index":"2","children":[{"title":"下载 cuda 镜像","id":"下载-cuda-镜像","index":"2.1"},{"title":"启动cuda容器","id":"启动cuda容器","index":"2.2"},{"title":"apt-get 换源：","id":"apt-get-换源：","index":"2.3"},{"title":"安装 anaconda3","id":"安装-anaconda3","index":"2.4"},{"title":"pip 换源","id":"pip-换源","index":"2.5"},{"title":"conda 换源","id":"conda-换源","index":"2.6"},{"title":"设置jupyter notebook","id":"设置jupyter-notebook","index":"2.7"},{"title":"安装pytorch","id":"安装pytorch","index":"2.8"},{"title":"打包成镜像","id":"打包成镜像","index":"2.9"}]},{"title":"使用","id":"使用","index":"3"}],"reward":true,"copyright":{"author":"Yuxin Zhao","link":"<a href=\"https://yuxinzhao.net/create-deep-learning-docker-image-in-ubuntu/\" title=\"Ubuntu上从CUDA开始构建深度学习镜像\">https://yuxinzhao.net/create-deep-learning-docker-image-in-ubuntu/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}